version: '3.8'

services:
  # Mock SSO server for testing
  mock-sso-server:
    build:
      context: ./strix_extensions/tests/mock_sso
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - LOG_LEVEL=DEBUG
    networks:
      - strix-sso-test

  # Mock protected application
  protected-app:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./strix_extensions/tests/protected_app:/usr/share/nginx/html:ro
    networks:
      - strix-sso-test

  # Strix with SSO extension
  strix-sso:
    build:
      context: .
      dockerfile: ./strix_extensions/tests/Dockerfile.strix
    depends_on:
      - mock-sso-server
      - protected-app
    environment:
      - STRIX_SANDBOX_MODE=false
      - STRIX_DISABLE_BROWSER=false
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    volumes:
      - ./strix_extensions:/workspace/strix_extensions:ro
      - ./run_strix_with_sso.py:/workspace/run_strix_with_sso.py:ro
    networks:
      - strix-sso-test
    command: >
      bash -c "
        pip install -r strix_extensions/requirements.txt &&
        python -m playwright install chromium &&
        python run_strix_with_sso.py --task 'Test SSO authentication'
      "

networks:
  strix-sso-test:
    driver: bridge

